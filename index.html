<!DOCTYPE html>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>葱妹 & 蒜姐</title>
    
    <!-- 外部依赖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="./index_files/jscex.min.js"></script>
    <script src="./index_files/jscex-parser.js"></script>
    <script src="./index_files/jscex-jit.js"></script>
    <script src="./index_files/jscex-builderbase.min.js"></script>
    <script src="./index_files/jscex-async.min.js"></script>
    <script src="./index_files/jscex-async-powerpack.min.js"></script>
    <script src="./index_files/functions.js"></script>
    <script src="./index_files/love.js"></script>

    <style>
        /* 基础样式 */
        body {
            margin: 0;
            padding: 0;
            background: #ffe;
            font-family: "Microsoft YaHei", sans-serif;
            overflow-x: hidden;
        }

        /* 主容器样式 */
        #main {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }

        #wrap {
            position: relative;
            margin: 0 auto;
            min-width: 1000px;
            min-height: 680px;
        }

        /* 文本框样式 */
        #text {
            width: 500px;
            position: absolute;
            left: 30px;
            top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 10;
        }

        #code {
            display: block;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
        }

        #code .say {
            display: block;
            margin: 12px 0;
        }

        /* 时钟样式 */
        #clock-box {
            position: absolute;
            left: 50%;
            bottom: 50px;
            transform: translateX(-50%);
            text-align: center;
            color: #333;
            z-index: 10;
        }

        /* 画布样式 */
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* 登录框样式 */
        #login-box {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-container input {
            display: block;
            width: 200px;
            padding: 10px;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-container button {
            background: #FF69B4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .login-container button:hover {
            background: #FF1493;
        }

        .login-container .error-msg {
            color: red;
            margin-top: 10px;
            display: none;
        }

        /* 响应式设计 */
        @media screen and (max-width: 767px) {
            body { font-size: 14px; }
            #main { padding: 10px; }
            #text {
                margin-top: 60px;
                margin-bottom: 100px;
            }
            #code { font-size: 14px; }
            #clock-box {
                font-size: 14px;
                position: fixed;
                bottom: 20px;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.9);
            }
            #canvas { height: 100vh; }
        }

        @media screen and (max-width: 320px) {
            #text { padding: 15px; }
            #code { font-size: 13px; }
            .login-container { padding: 20px; }
        }
    </style>
</head>
<body ondragstart="return false" oncontextmenu="return false" onselectstart="return false">
    <!-- 登录框 -->
    <div id="login-box">
        <div class="login-container">
            <h2>请输入密码</h2>
            <input type="password" id="password" placeholder="输入密码...">
            <button onclick="checkPassword()">进入</button>
            <p class="error-msg" id="error-msg">密码错误，请重试</p>
        </div>
    </div>

    <!-- 音乐播放器 -->
    <audio id="bgMusic" loop>
        <source src="./music/background.mp3" type="audio/mp3">
        <source src="https://raw.githubusercontent.com/only-left/onlyleft/main/music/background.mp3" type="audio/mp3">
    </audio>

    <!-- 主内容区域 -->
    <div id="main">
        <div id="error">
            本页面需要现代浏览器支持，请使用 Chrome 或 Firefox 的最新版本。
        </div>
        <div id="wrap">
            <div id="text">
                <div id="code">
                    <span class="say">傻瓜。</span>
                    <span class="say">我爱你，我知道你肯定会很无奈的说我知道你爱我呢。</span>
                    <span class="say">我想你，就像坐华师地铁线时总想遇见那个你相像的女孩。</span>
                    <!-- 其他文字内容 -->
                </div>
            </div>
            <div id="clock-box">
                葱妹和<span class="STYLE1"></span><font color="#33CC00">蒜姐</font>在一起
                <span class="STYLE1">已经....</span>
                <div id="clock"></div>
            </div>
            <canvas id="canvas" width="2000" height="1000"></canvas>
        </div>
    </div>

    <!-- JavaScript 代码 -->
    <script>
        // 音频控制模块
        const AudioController = {
            audio: null,
            isPlaying: false,

            init() {
                this.audio = document.getElementById('bgMusic');
                this.setupEventListeners();
            },

            setupEventListeners() {
                document.addEventListener('click', () => {
                    if (!this.isPlaying) {
                        this.play();
                    }
                }, { once: true });

                this.audio.addEventListener('playing', () => {
                    this.isPlaying = true;
                });

                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                });

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pause();
                    } else if (this.isPlaying) {
                        this.play();
                    }
                });
            },

            play() {
                this.audio.play().catch(error => console.log("播放失败:", error));
            },

            pause() {
                this.audio.pause();
            },

            toggle() {
                if (this.isPlaying) {
                    this.pause();
                } else {
                    this.play();
                }
                this.isPlaying = !this.isPlaying;
            }
        };

        // 画布尺寸控制
        const CanvasController = {
            canvas: null,

            init() {
                this.canvas = document.getElementById('canvas');
                this.setupEventListeners();
                this.resize();
            },

            setupEventListeners() {
                window.addEventListener('resize', () => this.resize());
                window.addEventListener('load', () => this.resize());
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
        };

        // 密码验证模块
        const LoginController = {
            correctPassword: "20081213",

            init() {
                document.getElementById('password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.checkPassword();
                    }
                });
            },

            checkPassword() {
                const password = document.getElementById('password').value;
                
                if (password === this.correctPassword) {
                    document.getElementById('login-box').style.display = 'none';
                    document.getElementById('main').style.display = 'block';
                    this.onLoginSuccess();
                } else {
                    document.getElementById('error-msg').style.display = 'block';
                    document.getElementById('password').value = '';
                }
            },

            onLoginSuccess() {
                startAnimation();
            }
        };

        // 时间计算模块
        const TimeController = {
            startDate: new Date(2008, 11, 13, 3, 0, 0),

            calculateElapsedTime() {
                const current = new Date();
                const seconds = Math.floor((current - this.startDate) / 1000);
                const days = Math.floor(seconds / (3600 * 24));
                const hours = Math.floor((seconds % (3600 * 24)) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);

                return {
                    days,
                    hours,
                    minutes,
                    seconds: secs
                };
            },

            updateClock() {
                const time = this.calculateElapsedTime();
                const clockDiv = document.getElementById('clock');
                clockDiv.innerHTML = `${time.days}天 ${time.hours}小时 ${time.minutes}分 ${time.seconds}秒`;
            },

            startClock() {
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
            }
        };

        const treeOptions = {
            seed: {
                x: window.innerWidth / 2 - 20,
                color: "rgb(190, 26, 37)",
                scale: 2
            },
            branch: [
                [535, 680, 570, 250, 500, 200, 30, 100, [
                    [540, 500, 455, 417, 340, 400, 13, 100, [
                        [450, 435, 434, 430, 394, 395, 2, 40]
                    ]],
                    [550, 445, 600, 356, 680, 345, 12, 100, [
                        [578, 400, 648, 409, 661, 426, 3, 80]
                    ]],
                    [539, 281, 537, 248, 534, 217, 3, 40],
                    [546, 397, 413, 247, 328, 244, 9, 80, [
                        [427, 286, 383, 253, 371, 205, 2, 40],
                        [498, 345, 435, 315, 395, 330, 4, 60]
                    ]],
                    [546, 357, 608, 252, 678, 221, 6, 100, [
                        [590, 293, 646, 277, 648, 271, 2, 80]
                    ]]
                ]] 
            ],
            bloom: {
                num: 700,
                width: 1080,
                height: 650,
            },
            footer: {
                width: 1200,
                height: 5,
                speed: 10,
            }
        };

        // 添加动画控制器
        const AnimationController = {
            tree: null,
            hold: 1,
            canvas: null,
            
            init() {
                this.canvas = $('#canvas');
                if (!this.canvas[0].getContext) {
                    $("#error").show();
                    return false;
                }

                const width = this.canvas.width();
                const height = this.canvas.height();
                this.canvas.attr("width", width);
                this.canvas.attr("height", height);

                // 初始化树
                this.tree = new Tree(this.canvas[0], width, height, treeOptions);
                this.setupEventListeners();
            },

            setupEventListeners() {
                this.canvas.click((e) => {
                    const offset = this.canvas.offset();
                    const x = e.pageX - offset.left;
                    const y = e.pageY - offset.top;
                    
                    if (this.tree.seed.hover(x, y)) {
                        this.hold = 0;
                        this.canvas.unbind("click");
                        this.canvas.unbind("mousemove");
                        this.canvas.removeClass('hand');
                    }
                }).mousemove((e) => {
                    const offset = this.canvas.offset();
                    const x = e.pageX - offset.left;
                    const y = e.pageY - offset.top;
                    this.canvas.toggleClass('hand', this.tree.seed.hover(x, y));
                });
            },

            // 种子动画
            async runSeedAnimation() {
                const seed = this.tree.seed;
                seed.draw();
                
                while (this.hold) {
                    await this.sleep(10);
                }
                
                $("#text").fadeIn(3000);
                
                while (seed.canScale()) {
                    seed.scale(0.95);
                    await this.sleep(10);
                }
                
                while (seed.canMove()) {
                    seed.move(0, 2);
                    this.tree.footer.draw();
                    await this.sleep(10);
                }
            },

            // 生长动画
            async runGrowAnimation() {
                while (this.tree.canGrow()) {
                    this.tree.grow();
                    await this.sleep(10);
                }
            },

            // 开花动画
            async runBloomAnimation() {
                while (this.tree.canFlower()) {
                    this.tree.flower(2);
                    await this.sleep(10);
                }
            },

            // 移动动画
            async runMoveAnimation() {
                this.tree.snapshot("p1", 240, 0, 610, 680);
                
                while (this.tree.move("p1", 500, 0)) {
                    this.tree.footer.draw();
                    await this.sleep(10);
                }
                
                this.tree.footer.draw();
                this.tree.snapshot("p2", 500, 0, 610, 680);

                // 更新背景
                this.canvas.parent().css("background", 
                    `url(${this.tree.toDataURL('image/png')})`);
                this.canvas.css("background", "#ffe");
                await this.sleep(300);
                this.canvas.css("background", "none");
            },

            // 跳跃动画
            async runJumpAnimation() {
                while (true) {
                    this.tree.ctx.clearRect(0, 0, this.canvas.width(), this.canvas.height());
                    this.tree.jump();
                    this.tree.footer.draw();
                    await this.sleep(25);
                }
            },

            // 文字动画
            async runTextAnimation() {
                $("#code").typewriter();
                $("#clock-box").fadeIn(500);
                
                while (true) {
                    TimeController.updateClock();
                    await this.sleep(1000);
                }
            },

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };

        // 添加启动动画的主函数
        async function startAnimation() {
            try {
                AnimationController.init();

                await AnimationController.runSeedAnimation();
                await AnimationController.runGrowAnimation();
                await AnimationController.runBloomAnimation();
                await AnimationController.runMoveAnimation();

                // 启动文字动画和跳跃动画
                AnimationController.runTextAnimation();
                await AnimationController.runJumpAnimation();
                
            } catch (error) {
                console.error("Animation error:", error);
            }
        }

        // 添加 Typewriter 效果的 jQuery 插件
        $.fn.typewriter = function() {
            const elements = this.children().filter('.say');
            let index = 0;
            
            function showNext() {
                if (index < elements.length) {
                    $(elements[index]).fadeIn(1000, function() {
                        setTimeout(showNext, 1000);
                    });
                    index++;
                }
            }
            
            showNext();
            return this;
        };

        // 初始化所有控制器
        document.addEventListener('DOMContentLoaded', () => {
            AudioController.init();
            CanvasController.init();
            LoginController.init();
        });
    </script>
</body>
</html>